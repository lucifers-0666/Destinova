/* ===================================================================
   DESTINOVA HEADER COMPONENT - JavaScript
   Handles: Navigation, Auth State, Dark Mode, Dropdowns, Mobile Menu
   =================================================================== */

(function() {
  'use strict';

  // ===================================================================
  // STATE MANAGEMENT
  // ===================================================================
  
  const HeaderState = {
    isUserLoggedIn: false,
    userName: '',
    currentPage: '',
    isDarkMode: false,
    
    init() {
      this.loadAuthState();
      this.loadDarkMode();
      this.detectCurrentPage();
    },
    
    loadAuthState() {
      const isSignedIn = localStorage.getItem('isUserSignedIn') === 'true';
      const userDetails = JSON.parse(localStorage.getItem('userDetails') || '{}');
      
      this.isUserLoggedIn = isSignedIn;
      this.userName = userDetails.name || userDetails.email || 'User';
    },
    
    loadDarkMode() {
      this.isDarkMode = localStorage.getItem('theme') === 'dark';
      const theme = this.isDarkMode ? 'dark' : 'light';
      document.documentElement.setAttribute('data-theme', theme);
    },
    
    detectCurrentPage() {
      const path = window.location.pathname;
      const page = path.split('/').pop().replace('.html', '') || 'index';
      this.currentPage = page;
    }
  };

  // ===================================================================
  // AUTH UI MANAGEMENT
  // ===================================================================
  
  const AuthUI = {
    init() {
      this.updateDesktopAuth();
      this.updateMobileAuth();
      this.attachLogoutHandlers();
    },
    
    updateDesktopAuth() {
      const authGuest = document.getElementById('auth-guest');
      const authUser = document.getElementById('auth-user');
      const userNameDisplay = document.getElementById('user-name-display');
      
      if (!authGuest || !authUser) return;
      
      if (HeaderState.isUserLoggedIn) {
        authGuest.style.display = 'none';
        authUser.style.display = 'flex';
        if (userNameDisplay) {
          userNameDisplay.textContent = HeaderState.userName;
        }
      } else {
        authGuest.style.display = 'flex';
        authUser.style.display = 'none';
      }
    },
    
    updateMobileAuth() {
      const mobileGuest = document.getElementById('mobile-auth-guest');
      const mobileUser = document.getElementById('mobile-auth-user');
      const mobileUserName = document.getElementById('mobile-user-name');
      
      if (!mobileGuest || !mobileUser) return;
      
      if (HeaderState.isUserLoggedIn) {
        mobileGuest.style.display = 'none';
        mobileUser.style.display = 'block';
        if (mobileUserName) {
          mobileUserName.textContent = `Hello, ${HeaderState.userName}`;
        }
      } else {
        mobileGuest.style.display = 'block';
        mobileUser.style.display = 'none';
      }
    },
    
    attachLogoutHandlers() {
      const logoutBtn = document.getElementById('logout-btn');
      const mobileLogoutBtn = document.getElementById('mobile-logout');
      
      if (logoutBtn) {
        logoutBtn.addEventListener('click', this.handleLogout);
      }
      
      if (mobileLogoutBtn) {
        mobileLogoutBtn.addEventListener('click', this.handleLogout);
      }
    },
    
    handleLogout(e) {
      e.preventDefault();
      
      // Clear auth state
      localStorage.removeItem('isUserSignedIn');
      localStorage.removeItem('userDetails');
      localStorage.removeItem('hasBookedTicket');
      
      // Show feedback
      alert('You have been logged out successfully.');
      
      // Redirect to home
      window.location.href = 'index.html';
    }
  };

  // ===================================================================
  // DROPDOWN MANAGEMENT
  // ===================================================================
  
  const Dropdowns = {
    init() {
      this.attachDesktopDropdowns();
      this.attachMobileDropdowns();
      this.attachProfileDropdown();
      this.closeOnOutsideClick();
    },
    
    attachDesktopDropdowns() {
      const dropdownBtns = document.querySelectorAll('.nav-dropdown .dropdown-btn');
      
      dropdownBtns.forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          const isExpanded = btn.getAttribute('aria-expanded') === 'true';
          
          // Close all other dropdowns
          this.closeAllDesktopDropdowns();
          
          // Toggle current
          btn.setAttribute('aria-expanded', !isExpanded);
        });
      });
    },
    
    attachMobileDropdowns() {
      const mobileBtns = document.querySelectorAll('.mobile-dropdown-btn');
      
      mobileBtns.forEach(btn => {
        btn.addEventListener('click', () => {
          const menu = btn.getAttribute('data-menu');
          const submenu = document.getElementById(`${menu}-submenu`);
          
          if (!submenu) return;
          
          const isVisible = submenu.style.display === 'block';
          
          // Toggle submenu
          submenu.style.display = isVisible ? 'none' : 'block';
          btn.textContent = btn.textContent.replace(/[▾▴]/, isVisible ? '▾' : '▴');
        });
      });
    },
    
    attachProfileDropdown() {
      const profileBtn = document.getElementById('profile-btn');
      const userDropdown = document.getElementById('user-dropdown');
      
      if (!profileBtn || !userDropdown) return;
      
      profileBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        const isExpanded = profileBtn.getAttribute('aria-expanded') === 'true';
        
        // Close desktop nav dropdowns
        this.closeAllDesktopDropdowns();
        
        // Toggle profile dropdown
        profileBtn.setAttribute('aria-expanded', !isExpanded);
        userDropdown.classList.toggle('show');
      });
    },
    
    closeAllDesktopDropdowns() {
      const dropdownBtns = document.querySelectorAll('.nav-dropdown .dropdown-btn');
      dropdownBtns.forEach(btn => {
        btn.setAttribute('aria-expanded', 'false');
      });
    },
    
    closeProfileDropdown() {
      const profileBtn = document.getElementById('profile-btn');
      const userDropdown = document.getElementById('user-dropdown');
      
      if (profileBtn && userDropdown) {
        profileBtn.setAttribute('aria-expanded', 'false');
        userDropdown.classList.remove('show');
      }
    },
    
    closeOnOutsideClick() {
      document.addEventListener('click', (e) => {
        const isDropdownClick = e.target.closest('.nav-dropdown, .user-menu');
        
        if (!isDropdownClick) {
          this.closeAllDesktopDropdowns();
          this.closeProfileDropdown();
        }
      });
    }
  };

  // ===================================================================
  // MOBILE MENU
  // ===================================================================
  
  const MobileMenu = {
    init() {
      this.attachToggleHandlers();
    },
    
    attachToggleHandlers() {
      const hamburgerBtn = document.getElementById('hamburger-btn');
      const mobileMenu = document.getElementById('mobile-menu');
      const mobileClose = document.getElementById('mobile-close');
      
      if (!hamburgerBtn || !mobileMenu) return;
      
      hamburgerBtn.addEventListener('click', () => {
        const isExpanded = hamburgerBtn.getAttribute('aria-expanded') === 'true';
        hamburgerBtn.setAttribute('aria-expanded', !isExpanded);
        hamburgerBtn.classList.toggle('active');
        mobileMenu.classList.toggle('active');
        
        // Prevent body scroll when menu is open
        document.body.style.overflow = !isExpanded ? 'hidden' : '';
      });
      
      if (mobileClose) {
        mobileClose.addEventListener('click', () => {
          hamburgerBtn.setAttribute('aria-expanded', 'false');
          hamburgerBtn.classList.remove('active');
          mobileMenu.classList.remove('active');
          document.body.style.overflow = '';
        });
      }
      
      // Close on link click
      const mobileLinks = mobileMenu.querySelectorAll('.mobile-link, .mobile-auth-btn');
      mobileLinks.forEach(link => {
        link.addEventListener('click', () => {
          hamburgerBtn.setAttribute('aria-expanded', 'false');
          hamburgerBtn.classList.remove('active');
          mobileMenu.classList.remove('active');
          document.body.style.overflow = '';
        });
      });
    }
  };

  // ===================================================================
  // DARK MODE TOGGLE
  // ===================================================================
  
  const DarkMode = {
    init() {
      const toggleBtn = document.getElementById('dark-mode-toggle');
      
      if (!toggleBtn) return;
      
      toggleBtn.addEventListener('click', () => {
        HeaderState.isDarkMode = !HeaderState.isDarkMode;
        const theme = HeaderState.isDarkMode ? 'dark' : 'light';
        document.documentElement.setAttribute('data-theme', theme);
        localStorage.setItem('theme', theme);
      });
    }
  };

  // ===================================================================
  // ACTIVE PAGE HIGHLIGHTING
  // ===================================================================
  
  const ActivePage = {
    init() {
      this.highlightCurrentPage();
    },
    
    highlightCurrentPage() {
      const navLinks = document.querySelectorAll('.nav-link[data-page], .dropdown-link[data-page], .mobile-link[data-page]');
      
      navLinks.forEach(link => {
        const linkPage = link.getAttribute('data-page');
        
        if (linkPage === HeaderState.currentPage) {
          link.classList.add('active');
        } else {
          link.classList.remove('active');
        }
      });
    }
  };

  // ===================================================================
  // STICKY HEADER SCROLL EFFECT
  // ===================================================================
  
  const StickyHeader = {
    init() {
      const header = document.getElementById('site-header');
      if (!header) return;
      
      window.addEventListener('scroll', () => {
        const scrolled = window.pageYOffset > 50;
        header.classList.toggle('scrolled', scrolled);
      });
    }
  };

  // ===================================================================
  // INITIALIZATION
  // ===================================================================
  
  function initHeader() {
    HeaderState.init();
    AuthUI.init();
    Dropdowns.init();
    MobileMenu.init();
    DarkMode.init();
    ActivePage.init();
    StickyHeader.init();
    
    console.log('✅ Destinova Header Component Initialized');
  }

  // Wait for DOM to be ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initHeader);
  } else {
    initHeader();
  }

  // ===================================================================
  // GLOBAL HEADER API (for external use)
  // ===================================================================
  
  window.DestinovaHeader = {
    refreshAuthState() {
      HeaderState.loadAuthState();
      AuthUI.updateDesktopAuth();
      AuthUI.updateMobileAuth();
    },
    
    setDarkMode(enabled) {
      HeaderState.isDarkMode = enabled;
      const theme = enabled ? 'dark' : 'light';
      document.documentElement.setAttribute('data-theme', theme);
      localStorage.setItem('theme', theme);
    },
    
    closeMobileMenu() {
      const hamburgerBtn = document.getElementById('hamburger-btn');
      const mobileMenu = document.getElementById('mobile-menu');
      
      if (hamburgerBtn && mobileMenu) {
        hamburgerBtn.setAttribute('aria-expanded', 'false');
        hamburgerBtn.classList.remove('active');
        mobileMenu.classList.remove('active');
        document.body.style.overflow = '';
      }
    }
  };

})();
